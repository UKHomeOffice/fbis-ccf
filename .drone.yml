---
kind: pipeline
name: default
type: kubernetes

steps:

- name: unit-test
  pull: if-not-exists
  image: node
  environment:
    NOTIFY_KEY: USE_MOCK
  commands:
  - npm install
  when:
    branch: kore
    event: push

- name: create-artefact-kore
  image: docker:dind
  environment:
    DOCKER_PASSWORD:
      from_secret: docker_password
  commands:
    - wget https://storage.googleapis.com/kore-releases/latest/kore-cli-linux-amd64
    - ln -s kore-cli-linux-amd64 kore
    - ls -l
    - ./kore version
    - echo kore run build build-it -t fbis
  volumes:
    - name: dockersock
      path: /var/run
  when:
    branch: kore
    event: push

- name: deploy-to-dev
  pull: if-not-exists
  image: quay.io/ukhomeofficedigital/kd:v1.14.0
  commands:
  - export KUBE_TOKEN=$${KUBE_TOKEN_FBIS_ACP_NOTPROD}
  - echo Deployed
  environment:
    KUBE_NAMESPACE: sas-fbis-dev
    KUBE_SERVER: https://kube-api-notprod.notprod.acp.homeoffice.gov.uk
    KUBE_TOKEN_FBIS_ACP_NOTPROD:
      from_secret: kube_token_fbis_acp_notprod_kore
  when:
    branch: kore
    event: push

services:
  - name: docker
    image: docker:dind
    volumes:
      - name: dockersock
        path: /var/run

volumes:
  - name: dockersock
    temp: {}

...
